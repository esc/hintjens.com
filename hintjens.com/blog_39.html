<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">


<!-- Mirrored from hintjens.com/blog:39 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 09 Oct 2019 09:31:02 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <title>Securing ZeroMQ: draft ZMTP v3.0 Protocol - Hintjens.com</title>
    
    	<script type="text/javascript" src="http://www.wikidot.com/default__flow/login__CustomDomainScript?site_id=352120"></script>

    
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--javascript/init.combined.js"></script>
    <script  type="text/javascript">
        var URL_HOST = 'www.wikidot.com';
        var URL_DOMAIN = 'wikidot.com';
        var USE_SSL =  true ;
        var URL_STATIC = 'http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade';
        // global request information
        
        var WIKIREQUEST = {};
        WIKIREQUEST.info = {};
        
        WIKIREQUEST.info.domain = "hintjens.com";
        WIKIREQUEST.info.siteId = 352120;
        WIKIREQUEST.info.siteUnixName = "hintjens";
        WIKIREQUEST.info.categoryId = 1984291;
        WIKIREQUEST.info.themeId = 1;
        WIKIREQUEST.info.requestPageName = "blog:39";
        OZONE.request.timestamp = 1570613247;
        OZONE.request.date = new Date();
        WIKIREQUEST.info.lang = 'en';
                WIKIREQUEST.info.pageUnixName = "blog:39";
        WIKIREQUEST.info.pageId = 17484658;
                        WIKIREQUEST.info.lang = "en";
        OZONE.lang = "en";
        var isUAMobile = !!/Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    </script>
    
    


    
        <script  type="text/javascript">
    
        require.config({
            baseUrl: URL_STATIC + '/common--javascript',
            paths: {
                'jquery.ui': 'jquery-ui.min',
                'jquery.form': 'jquery.form'
            }
        });
    
    </script>
    
    <meta http-equiv="content-type" content="text/html;charset=UTF-8"/>
            
    
    
    
    
    <meta http-equiv="content-language" content="en"/>
    <script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--javascript/WIKIDOT.combined.js"></script>
        
    
    <style type="text/css" id="internal-style">
        
        /* modules */
@import url(http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--modules/css/pagerate/PageRateWidgetModule.css);


        
                
        /* theme */
                    @import url(http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--theme/base/css/style.css);
                    @import url(http://hintjens.wdfiles.com/local--code/admin%3Athemes/1);
            </style>
    
        
        
        
    <link rel="shortcut icon" href="local--favicon/favicon.gif"/>
    <link rel="icon" type="image/gif" href="local--favicon/favicon.gif"/>
    
            <link rel="apple-touch-icon" href="common--images/apple-touch-icon-57x57.png" />
        <link rel="apple-touch-icon" sizes="72x72" href="common--images/apple-touch-icon-72x72.png" />
        <link rel="apple-touch-icon" sizes="114x114" href="common--images/apple-touch-icon-114x114.png" />
        
        
            <link rel="alternate" type="application/wiki" title="Edit this page" href="javascript:WIKIDOT.page.listeners.editClick()"/>
    
        <script type="text/javascript">
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-18234656-1']);
        _gaq.push(['_setDomainName', 'none']);
        _gaq.push(['_setAllowLinker', true]);
        _gaq.push(['_trackPageview']);

        _gaq.push(['old._setAccount', 'UA-68540-5']);
        _gaq.push(['old._setDomainName', 'none']);
        _gaq.push(['old._setAllowLinker', true]);
        _gaq.push(['old._trackPageview']);

                _gaq.push(['userTracker._setAccount', 'UA-623476-16']);
        _gaq.push(['userTracker._trackPageview']);
            </script>
    
    <script type="text/javascript">
        window.google_analytics_uacct = 'UA-18234656-1';
        window.google_analytics_domain_name = 'none';
    </script>
    
        <link rel="manifest" href="onesignal/manifest.html" />
    <script src="https://cdn.onesignal.com/sdks/OneSignalSDK.js" acync=""></script>
    <script>
        var OneSignal = window.OneSignal || [];
        OneSignal.push(function() {
          OneSignal.init({
            appId: null,
          });
        });
    </script>
        
<link rel="alternate" type="application/rss+xml" title="Comments for the page &quot;Securing ZeroMQ: draft ZMTP v3.0 Protocol&quot;" href="feed/page/comments-17484658.xml"/><script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--modules/js/misc/NewPageHelperModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--modules/js/list/ListPagesModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--modules/js/pagerate/PageRateWidgetModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--modules/js/forum/ForumCommentsModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--modules/js/forum/ForumViewThreadModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--modules/js/forum/sub/ForumNewPostFormModule.js"></script>
<script type="text/javascript" src="http://d3g0gp89917ko0.cloudfront.net/v--b23e476b7ade/common--modules/js/forum/ForumViewThreadPostsModule.js"></script>
</head>
<body id="html-body">
<div id="skrollr-body">
<a name="page-top"></a>

<div id="container-wrap-wrap">
    <div id="container-wrap">
        <div id="container">
            <div id="header">
              <h1><a href="index.html"><span>Hintjens.com</span></a></h1>
                
                    <h2><span>Moving Pieces</span></h2>
                
                
                <!-- google_ad_section_start(weight=ignore) -->
                
                <div id="search-top-box" class="form-search">
    <form id="search-top-box-form" action="http://hintjens.com/dummy" class="input-append">
        <input id="search-top-box-input" class="text empty search-query" type="text" size="15" name="query" value="Search this site" onfocus="if(YAHOO.util.Dom.hasClass(this, 'empty')){YAHOO.util.Dom.removeClass(this,'empty'); this.value='';}"/><input class="button btn" type="submit" name="search" value="Search"/>
    </form>
</div>
                
                
                    <div id="top-bar">
                        

<ul>
<li><a href="index.html">Front</a></li>
<li><a href="blog__zeromq.html">ZeroMQ</a></li>
<li><a href="blog__community.html">Community</a></li>
<li><a href="blog__unprotocols.html">Unprotocols</a></li>
<li><a href="blog__psychopaths.html">Psychopaths</a></li>
</ul>

                    </div>
                
                <div id="login-status"><a href="javascript:;" onclick="WIKIDOT.page.listeners.createAccount(event)" class="login-status-create-account btn">Create account</a> <span>or</span> <a href="javascript:;" onclick="WIKIDOT.page.listeners.loginClick(event)" class="login-status-sign-in btn btn-primary">Sign in</a> </div>
                <div id="header-extra-div-1"><span></span></div><div id="header-extra-div-2"><span></span></div><div id="header-extra-div-3"><span></span></div>
            </div>
            
            <div id="content-wrap">
                
                    <div id="side-bar">
                        


                        

<p><a class="wiki-standalone-button" style="background-image: url(http://www.wikidot.com/local--files/files/document-print.png); background-repeat: no-repeat; background-position: bottom right; padding-right: 20px;color: #444" href="javascript:;" onclick="WIKIDOT.page.listeners.printClick(event)">print</a></p>
<a href="http://hintjens.wdfiles.com/local--files/nav:side/culture.jpg"><img src="http://hintjens.wdfiles.com/local--resized-images/nav:side/culture.jpg/small.jpg" alt="culture.jpg" class="image" /></a>
<p><strong>Pieter Hintjens</strong></p>
<p><a href="main_biography.html">Biography</a> | <a href="main_portfolio.html">Portfolio</a> | <a href="https://github.com/hintjens">GitHub</a><br />
<a href="books.html">Books</a> | <a href="https://vimeo.com/user10099130/videos">Videos</a> | <a href="http://www.slideshare.net/pieterh">Slides</a> | <a href="http://fiction.hintjens.com/">Stories</a> | <a href="http://wiki.hintjens.com/">Wiki</a><br />
<a href="contact.html">Contact</a></p>
<p><strong>Thank you for the gifts</strong></p>
<p><a href="http://paypal.me/Hintjens">Kind people already sent donations</a> that will make my childrens' lives easier, when I'm not there any more. Thank you enormously! :-)</p>
<p>Podcasts/Interviews</p>
<p><a href="http://softwareengineeringdaily.com/2016/06/23/death-distributed-systems-pieter-hintjens/">Software Engineering Daily</a><br />
<a href="https://www.youtube.com/watch?v=ApqI9XLRk4k">Interview by Adam Dymitruk</a><br />
<a href="http://devchat.tv/ruby-rogues/188-rr-community-building-with-pieter-hintjens">Ruby Rogues #188, Community Building</a></p>
<p>Talks on video</p>
<p><a href="http://deredactie.be/cm/vrtnieuws/videozone/programmas/deafspraak/2.44331">&quot;De afspraak&quot;, VRT, May 2016</a> (panel discussion)<br />
<a href="http://www.rtl.be/rtltvi/video/581260.aspx">RTL TV, May 2016</a> (panel discussion)<br />
<a href="https://www.youtube.com/watch?v=uzxcILudFWM">DomCode 2015, Nov 2015</a> (keynote)<br />
<a href="https://www.youtube.com/watch?v=7HECD3eLoVo">Coding Serbia, Oct 2015</a> (keynote)<br />
<a href="https://www.youtube.com/watch?v=O8CbzKREAj4">Euroscipy, Cambridge, Aug 2015</a> (keynote)<br />
<a href="https://www.youtube.com/watch?v=FKu09-_AaeM&amp;index=4&amp;list=PLFxMLyzsWeqr4SCyx0ZmFkVz2vZJk_CI5">PyGrunn, Groningen, May 2015</a><br />
<a href="http://www.ustream.tv/recorded/61450822">Craft Conf, Budapest, Apr 2015</a><br />
<a href="http://www.infoq.com/presentations/protocol-design-2015">QCon London, Mar 2015</a><br />
<a href="http://www.infoq.com/presentations/protocol-design">Code Mesh London, Nov 2014</a><br />
<a href="http://www.infoq.com/presentations/trick-better-software">Build Stuff, Vilnius 2014</a><br />
<a href="https://www.youtube.com/watch?v=_QF9sFJGJuc">Build Stuff, Vilnius, Nov 2014</a> (interview)<br />
<a href="https://www.youtube.com/watch?v=xFVDNTXIC_Y">Coding Serbia, Nov 2014</a> (keynote)<br />
<a href="https://www.youtube.com/watch?v=DAOFZfSlFs0">Devnology, Leusden, Oct 2014</a> (keynote)<br />
<a href="https://www.youtube.com/watch?v=QB7VXSc5H3A">EuroPython, Berlin, Jul 2014</a> (keynote)<br />
<a href="https://www.youtube.com/watch?v=qTNqgwN5gzA&amp;feature=youtu.be">Build Stuff, Vilnius, Dec 2013</a> (interview)<br />
<a href="http://www.infoq.com/presentations/digital-revolution-freedom">Build Stuff, Vilnius, Dec 2013</a> (keynote)<br />
<a href="http://vimeo.com/82175816">Code Mesh London, Dec 2013</a><br />
<a href="http://vimeo.com/79378301">DevOps Days, London, Nov 2013</a><br />
<a href="https://vimeo.com/68236487">NDC Oslo, Jun 2013</a><br />
<a href="https://vimeo.com/69666055">CERN - Geneva, Jun 2013</a><br />
<a href="https://www.youtube.com/watch?v=uj-li0LO_2g">Tech Mesh, London, Dec 2012</a><br />
<a href="http://www.infoq.com/presentations/Architecture-Scale-ZeroMQ">Strange Loop, St.Louis, Oct 2012</a><br />
<a href="https://vimeo.com/37854675">ZeroMQ@PDX part 2 - Portland, Feb 2012</a><br />
<a href="https://vimeo.com/38117896">ZeroMQ@PDX part 1 - Portland, Feb 2012</a><br />
<a href="http://www.youtube.com/watch?gl=BE&amp;v=4II94h6-IFY">FLOSS Weekly, Petaliuma CA, Dec 2011</a><br />
<a href="https://www.youtube.com/watch?v=CCBYzKfmQ4U">FOSDEM 2011, Brussels</a><br />
<a href="https://www.youtube.com/watch?v=h0facLxJPUE">Berlin Buzzwords 2010</a> (keynote)<br />
<a href="https://www.youtube.com/watch?v=bQgPArfbXm4">FOSDEM 2009, Brussels</a><br />
<a href="https://www.youtube.com/watch?v=fJo1jmuOuqQ">Hellenic FOSS Conference 2008, Athens part 1</a><br />
<a href="https://www.youtube.com/watch?v=Hx6cS1VLhoo">Hellenic FOSS Conference 2008, Athens part 2</a></p>
<p>Email me at <span class="wiki-email">moc.snejtnih|reteip#moc.snejtnih|reteip</span> if you'd like me to present at your event, or in your organization.</p>
<a href="books.html"><img src="https://www.createspace.com/Img/T448/T45/T21/BookCoverImage.jpg?random=0.4431380270844333" style="padding:5px" width="100" alt="BookCoverImage.jpg?random=0.4431380270844333" class="image" /></a>
<div style="clear:both; height: 0px; font-size: 1px"></div>
<a href="books.html"><img src="http://hintjens.wdfiles.com/local--files/nav:side/socarch.png" style="padding:5px" width="100" alt="socarch.png" class="image" /></a>
<div style="clear:both; height: 0px; font-size: 1px"></div>
<a href="books.html"><img src="http://hintjens.wdfiles.com/local--files/nav:side/confessions.jpg" style="padding:5px" width="100" alt="confessions.jpg" class="image" /></a>
<div style="clear:both; height: 0px; font-size: 1px"></div>
<a href="books.html"><img src="http://hintjens.wdfiles.com/local--files/nav:side/psccover.jpg" style="padding:5px" width="100" alt="psccover.jpg" class="image" /></a>
<div style="clear:both; height: 0px; font-size: 1px"></div>
<a href="books.html"><img src="http://akamaicovers.oreilly.com/images/0636920026136/cat.gif" style="padding:5px" width="100" alt="cat.gif" class="image" /></a>
<div style="clear:both; height: 0px; font-size: 1px"></div>
<a href="books.html"><img src="http://hintjens.wdfiles.com/local--files/nav:side/scalablec.png" style="padding:5px" width="100" alt="scalablec.png" class="image" /></a>
<div style="clear:both; height: 0px; font-size: 1px"></div>
<a href="books.html"><img src="https://www.createspace.com/Img/T409/T85/T11/BookCoverImage.jpg?random=0.7859812398986378" style="padding:5px" width="100" alt="BookCoverImage.jpg?random=0.7859812398986378" class="image" /></a>
<div style="clear:both; height: 0px; font-size: 1px"></div>
<p><strong><a href="books.html">Download and read online</a></strong></p>
<p><strong><a href="legal_start.html">Legal</a> | <a href="about.html">About</a> | <a href="contact.html">Contact</a></strong></p>
<div class="collapsible-block">
<div class="collapsible-block-folded"><a class="collapsible-block-link" href="javascript:;"> ▽ </a></div>
<div class="collapsible-block-unfolded" style="display:none">
<div class="collapsible-block-unfolded-link"><a class="collapsible-block-link" href="javascript:;"> △ </a></div>
<div class="collapsible-block-content">
<div class="side-box">
<p><a href="_admin.html">Manage</a> | <a href="admin_themes.html">Theme</a> | <a href="nav_top.html">Top</a> | <a href="nav_top.html">Side</a></p>

<div class="new-page-box" style="text-align: center; margin: 1em 0;">
	<form action="http://hintjens.com/dummy.html" method="get" onsubmit="WIKIDOT.modules.NewPageHelperModule.listeners.create(event);">
		<input class="text" name="pageName" type="text" size="40" maxlength="128" style="margin: 1px"/>
				<input type="submit" class="button" value="New post" style="margin: 1px;"/>
									<input type="hidden" name="categoryName" value="blog"/>
													<input type="hidden" name="parent" value="blog:_start"/>
				
	</form>
</div>
</div>
</div>
</div>
</div>

                        


                    </div>
                
                
                <!-- google_ad_section_end -->
                
                <div id="main-content">
                    <div id="action-area-top"></div>
                    
                    
                        <div id="page-title">
                            Securing ZeroMQ: draft ZMTP v3.0 Protocol
                        </div>
                    

                    
                        <div id="breadcrumbs">
                            <a href="blog__start.html">All Articles</a> &raquo; Securing ZeroMQ: draft ZMTP v3.0 Protocol
                        </div>
                    

                    



                    <div id="page-content">
                        

<div style="overflow:hidden; font-size: 13px; margin: -26px 0 -22px 0">
<div style="float:left"><div class="list-pages-box">    

<p><a href="blog_38.html">&lt; Previous</a></p>

    
    
    
    </div></div>
<div style="float:right"><div class="list-pages-box">    

<p><a href="blog_40.html">Next &gt;</a></p>

    
    
    
    </div></div>
</div>
<div style="border: solid 1px #f00; padding:0 1em 0 1em; margin-bottom: 1em; margin-top:1em; min-height: 140px; overflow: hidden">
<p><span class="printuser avatarhover"><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;"><img class="small" src="http://www.wikidot.com/avatar.php?userid=99&amp;amp;size=small&amp;amp;timestamp=1473156442" alt="pieterh" style="background-image:url(http://www.wikidot.com/userkarma.php?u=99)" /></a><a href="http://www.wikidot.com/user:info/pieterh" onclick="WIKIDOT.page.listeners.userInfo(99); return false;">pieterh</a></span> wrote on <span class="odate time_1365938156 format_%25e%20%25b%2C%20%25H%3A%25M%20%28%25O%20ago%29">14 Apr 2013 11:15</span></p>
<div class="image-container floatleft"><a href="http://hintjens.wdfiles.com/local--files/blog:39/chat3.png"><img src="http://hintjens.wdfiles.com/local--resized-images/blog:39/chat3.png/small.jpg" alt="chat3.png" class="image" /></a></div>
<p>In <a href="blog_36.html">the previous article</a> in this series, &quot;Securing ZeroMQ&quot;, I showed a proof-of-concept for CurveZMQ. Now we're moving that into the ZeroMQ protocol, ZMTP. It's not a small change. You can't just sprinkle security over a protocol like chocolate chips onto pancakes. It means a new protocol, and this gives us a chance to address other problems with ZMTP. The result is <a href="http://rfc.zeromq.org/spec:23">ZMTP v3.0</a>. In this article I'll explain ZMTP v3.0. If you never read the 1.0 or 2.0 spec, don't worry, I'll cover those briefly too.</p>
<table style="margin:0; padding:0">
<tr>
<td style="margin:0; padding:0">
<div id="toc">
<div id="toc-action-bar"><a href="javascript:;" onclick="WIKIDOT.page.listeners.foldToc(event)">Fold</a><a style="display: none" href="javascript:;" onclick="WIKIDOT.page.listeners.unfoldToc(event)">Unfold</a></div>
<div class="title">Table of Contents</div>
<div id="toc-list">
<div style="margin-left: 2em;"><a href="#toc0">Real Protocols are Worth It</a></div>
<div style="margin-left: 2em;"><a href="#toc1">Goals</a></div>
<div style="margin-left: 2em;"><a href="#toc2">Overall Behavior</a></div>
<div style="margin-left: 2em;"><a href="#toc3">Version Negotiation</a></div>
<div style="margin-left: 2em;"><a href="#toc4">Commands, Messages and Frames</a></div>
<div style="margin-left: 2em;"><a href="#toc5">Authentication and Confidentiality</a></div>
<div style="margin-left: 2em;"><a href="#toc6">The NULL Security Mechanism</a></div>
<div style="margin-left: 2em;"><a href="#toc7">The PLAIN Mechanism</a></div>
<div style="margin-left: 2em;"><a href="#toc8">The CURVE Mechanism</a></div>
<div style="margin-left: 2em;"><a href="#toc9">Pluggable Authentication</a></div>
<div style="margin-left: 2em;"><a href="#toc10">Connection Metadata</a></div>
<div style="margin-left: 2em;"><a href="#toc11">Virtual Addressing</a></div>
<div style="margin-left: 2em;"><a href="#toc12">Security Considerations</a></div>
<div style="margin-left: 2em;"><a href="#toc13">Conclusions</a></div>
</div>
</div>
</td>
</tr>
</table>
<h2 id="toc0"><span>Real Protocols are Worth It</span></h2>
<p>ZeroMQ used to have a sweet but unrealistic story: &quot;our API looks like plain sockets, and we have practically no protocol&quot;. As it turns out, this was great marketing but not great technical design. The plain BSD socket API doesn't work for messaging (Contexts? Multipart messages? Zero-copy? Events? Threads?), and a non-protocol doesn't provide the number one guarantee users want, which is interoperability (you need version numbers).</p>
<p>ZMTP v1.0 was simple: each peer connected and then started blasting messages to each other. This is the protocol that libzmq v2.x speaks. The later release, v3.1 speaks a dialect of this protocol where subscribers send subscriptions upstream to publishers. You can't mix v2.x and v3.1 pub-sub on the same network.</p>
<p>We designed and implemented ZMTP v2.0 about a year ago. It added version numbering, and fixed the framing to be more sensible. This is the protocol the current libzmq v3.2 speaks (it will also downgrade to speak to older 2.x peers). It was a minimal change, and didn't address a bunch of other problems in ZMTP.</p>
<p>By 2013 it was clear that the number one problem with ZMTP is the lack of security. As I've shown in previous articles, it's not technically so difficult. It just needs to be done. At the same time, since adding security means big changes, we (Martin Hurton and myself) decided to address a few of the other long-standing problems in the protocol. These are mostly just questions the protocol should answer, but didn't.</p>
<p>As you read these changes, understand the <a href="blog_9.html">&quot;Cheap and Nasty&quot;</a> pattern. We connect once, and then exchange millions of messages over hours or days. The message transfer is asynchronous, changes very little over time, and has to be as efficient as possible. But creating a connection is synchronous, changes a lot over time, and efficiency is utterly irrelevant.</p>
<p>When you get this, you begin to see how to design what I'd consider a real messaging protocol. It breaks into two parts: a chatty negotiation at the start, and a high-speed asynchronous data stream thereafter. The negotiation needs to define commands with structure, and extensibility in the form of dictionaries (binary, or text, it doesn't really matter). ZMTP v2.0 didn't even start to go into this direction. In fact it broke that pattern by for instance sending meta data (identities and subscriptions) as messages.</p>
<h2 id="toc1"><span>Goals</span></h2>
<p>A good way to understand ZMTP is to start with a plain TCP connection and then see what problems we need to solve in order to get a working message transport:</p>
<ul>
<li>TCP carries a stream of bytes with no delimiters, but we want to send and receive discrete messages. Thus, ZMTP reads and writes <em>frames</em> consisting of a size and a body.</li>
</ul>
<ul>
<li>We need to carry metadata on each frame (such as, whether the frame is part of a multipart message, or not). ZMTP provides a <em>flags</em> field in each frame for metadata.</li>
</ul>
<ul>
<li>We need to be able to talk to older implementations, so that our framing can evolve without breaking existing implementations. ZMTP defines a <em>greeting</em> that announces the implemented version number, and specifies a method for version negotiation.</li>
</ul>
<ul>
<li>We need security so that peers can be sure of the identity of the peers they talk to, and so that messages cannot be tampered with, nor inspected, by third parties. ZMTP defines a <em>security handshake</em> that allows peers to create a secure connection.</li>
</ul>
<ul>
<li>We need a range of security protocols, from clear text (no security, but fast) to fully authenticated and encrypted (secure, but slow). Further, we need the freedom to add new security protocols over time. ZMTP defines a way for peers to agree on an extensible <em>security mechanism</em>.</li>
</ul>
<ul>
<li>We need a way to carry metadata about the connection, after the security handshake. ZMTP defines a standard set of <em>metadata properties</em> (socket type, identity, etc.) that peers exchange after the security mechanism.</li>
</ul>
<ul>
<li>We want to allow multiple tasks to share a single external unique interface and port, to decrease system administration costs. ZMTP defines a <em>resource</em> metadata property that lets any number of tasks share a single interface and port.</li>
</ul>
<h2 id="toc2"><span>Overall Behavior</span></h2>
<p>A ZMTP connection goes through these main stages:</p>
<ul>
<li>The two peers agree on the version and security mechanism of the connection by sending each other data and either continuing the discussion, or closing the connection.</li>
<li>The two peers handshake the security mechanism by exchanging zero or more commands. If the security handshake is successful, the peers continue the discussion, otherwise one or both peers closes the connection.</li>
<li>Each peer then sends the other metadata about the connection as a final command. The peers may check the metadata and each peer decides either to continue, or to close the connection.</li>
<li>Each peer is then able to send the other messages. Either peer may at any moment close the connection.</li>
</ul>
<h2 id="toc3"><span>Version Negotiation</span></h2>
<p>ZMTP v3.0 makes it much clearer how to do version negotiation. Each peer sends part of the greeting, and the higher version number can decide to downgrade to the lower version number. Thus implementations can choose to be backwards compatible (as libzmq is), but do not need to try to be forwards compatible (which is kind of hard). If you're a v3.0 peer and you get a greeting from a v4.0 peer, you just continue. If the 4.0 peer doesn't want to downgrade to your protocol, it'll close the connection.</p>
<h2 id="toc4"><span>Commands, Messages and Frames</span></h2>
<p>Following the greeting, which has a fixed size of 64 octets, all further data is sent as size-specified frames. <em>Command frames</em> are used in the security handshake, and <em>message frames</em> are used to carry clear text application data. Commands always consist of a single frame. Messages consist of one or more frames.</p>
<p>A ZMTP connection is either clear text, or encrypted, according to the security mechanism. On a clear text connection, message data is always sent as message frames, using a single consistent format, so that traffic analysis tools don't need to know the specific details of a clear text mechanism. On an encrypted connection, message data is always encoded as commands so that wire analysis is not possible. (You'll never see message frames on a secure connection, period.)</p>
<p>The frame has the same format as in v2.0 (like I said, the asynchronous high-volume part of a protocol rarely changes once you get it right). It has a 1 byte flags field, followed by one or eight bytes of size, followed by body data. The only change we made in v3.0 was to add another flag bit to mark command frames.</p>
<p>People have proposed various other flag fields in the past, e.g. marking the first and last frame of a message rather than &quot;more&quot;. Or, adding a &quot;label&quot; bit to mark message envelopes separately from message content (this would get rid of the null delimiter frame that request-reply still uses).</p>
<p>Right now, ZMTP still doesn't know much about actual socket semantics, but we could start to add this. I'd like, for example, to be more explicit about XSUB/XPUB subscribe and unsubscribe commands, which are now sent as messages with a special first byte. We could also do heartbeating and more. Actually it's not hard to add features. The real cost is not even implementing them, it's ensuring existing applications can migrate safely onto new stacks.</p>
<h2 id="toc5"><span>Authentication and Confidentiality</span></h2>
<p>Now we come to the meat of ZMTP v3.0, which is security. More specifically, do we know who we're talking to, and are our conversations fully private?</p>
<p>Making secure protocols is complex, dangerous, and thankless work unless you find a way to cheat and make it all Someone Else's Problem. For ZMTP I borrowed from the IETF's Simple Authentication and Security Layer (SASL), aka <a href="http://tools.ietf.org/html/rfc4422">RFC 4422</a>, and the NaCl <a href="http://curvecp.org/">CurveCP security handshake</a>. (I've explained my proposal for creative abuse of CurveCP in previous articles.)</p>
<p>If you haven't studied SASL, and you care even a little about security protocols, you should go off and read my latest book, called &quot;SASL Made Simple&quot; (1,350 pages, from iMatix University Press, $95.50 plus S&amp;H). Just kidding&#8230; we can boil SASL down to a few key design elements:</p>
<ul>
<li>The server proposes, and the client accepts, a &quot;security mechanism&quot;, which is a string.</li>
<li>The implementations use the security mechanism to lookup a library that implements it.</li>
<li>The server and client exchange challenges and responses, which are binary blobs.</li>
<li>These blobs are passed to the security library, which digests them and possibly produces a new challenge or response.</li>
<li>Eventually the security library at each side says, &quot;OK, ready&quot;, and the server and client can now communicate.</li>
</ul>
<p>It's a little more subtle than this, but that's the basic idea. After the two peers shake hands, they can send each other messages encrypted by the security library. Message I/O is still handled by the same code, with the security library acting as a filter (it encodes and decodes messages as needed).</p>
<p>What SASL does is pretty magic. First, we can add security mechanisms arbitrarily. The mechanism I want to use for ZMTP is CurveZMQ, but perhaps someone else will make a DTLS mechanism. Remember, each mechanism is a plug in library that doesn't need to know how data gets passed around. It takes blobs, produces blobs, and holds state about the connection. In my <a href="blog_36.html">previous article</a> I showed how a such a filter works.</p>
<p>Splitting the security work off makes it much easier to solve. We can test the mechanisms in isolation, before we plug them into real messaging. It also leaves the protocol totally naive about security. That means that as we switch to newer, faster security models, we don't have to change the protocol.</p>
<p>A peer announces precisely one security mechanism, unlike SASL, which lets servers announce multiple security mechanisms. Security in ZMTP is <em>assertive</em> in that all peers on a given socket have the same, required level of security. This prevents downgrade attacks and simplifies implementations.</p>
<p>When we use this approach, every connection always uses a security mechanism. Of course for most traffic will still be clear text. So ZMTP comes with three mechanisms: NULL (no security), PLAIN (clear text authentication) and CURVE (full security). PLAIN is there for two reasons. One, it provides a decent model for other mechanisms. I'll explain that model in a tick. Two, clear text authentication is pretty useful on internal networks. You don't want that test client connecting to the production server and sending 1M test messages by accident.</p>
<h2 id="toc6"><span>The NULL Security Mechanism</span></h2>
<p>The NULL mechanism is easiest to understand - it gives us pretty much what we already have with ZMTP v2.0. The big difference is that there's an explicit READY command to send metadata (what you'd call &quot;headers&quot; in HTTP). Metadata is one of those things you really, <em>really</em> want to send in an extensible dictionary, since this is where 80% of the experimentation and profit comes from in protocols.</p>
<p>In the NULL mechanism, each peer sends off a READY to the other, and can then send or receive messages. They can check each others' metadata, e.g. to validate socket types. If either peer doesn't want to continue it simply closes the connection.</p>
<p>There's something about designing protocols to work like real human interactions that pleases me, and feels right. So there's no error reporting in ZMTP. If the peer closes the connection during handshaking, that's a strong rejection (take the hint, and don't connect again!), whereas if the peer closes the connection later, that's a temporary blip (sorry, got distracted, please connect again).</p>
<p>Here's the grammar for the NULL mechanism:</p>
<div class="code">
<pre>
<code>null = ready *message
ready = command-size &quot;READY   &quot; *property
property = name value
name = OCTET *name-char
name-char = ALPHA | DIGIT | &quot;-&quot; | &quot;_&quot; | &quot;.&quot; | &quot;+&quot;
value = 4OCTET *OCTET       ; Size in network byte order</code>
</pre></div>
<p>Commands always start with a fixed-space 8 character name, and then descend into whatever form of madness makes the command work. For READY, we are sending a metadata dictionary. I decided to go with short text names and long binary values. 2GB should be enough for anyone. This format seems easy to create or parse in any language.</p>
<h2 id="toc7"><span>The PLAIN Mechanism</span></h2>
<p>I'll explain how ZMTP's security works, because if we're going to use this for real work, we need criticism. I've some ideas for encouraging people to try to break the CURVE mechanism, but that's for later.</p>
<p>Since I've not finished documenting <a href="http://rfc.zeromq.org/spec:25">CURVE</a>, we'll look at <a href="http://rfc.zeromq.org/spec:24">PLAIN</a>. These two mechanisms <a href="http://rfc.zeromq.org/spec:25">have</a> <a href="http://rfc.zeromq.org/spec:24">RFCs</a> already, and you'll see that they use the precise same command grammar:</p>
<div class="code">
<pre>
<code>C:hello S:welcome C:initiate S:ready *( C:message | S:message )</code>
</pre></div>
<p>This was deliberate. The handshake is synchronous and consists of two requests from the client and two responses from the server. For PLAIN, we could collapse this to one request and one reply. For CURVE it has to be split up, since the initiate-ready step depends on security already established by hello-welcome. (Note that in CurveCP, which is the original design for the CURVE mechanism, the command is called COOKIE, not WELCOME).</p>
<p>So conceptually, we have three steps:</p>
<ul>
<li>Establish security (HELLO, WELCOME).</li>
<li>Send meta data (INITIATE, READY).</li>
<li>Send messages.</li>
</ul>
<p>While the first four commands are synchronous, messages are async. That is, the client can start sending messages as soon as it's received READY, and the server can send messages right after it's sent READY. INITIATE and READY carry metadata, like the NULL mechanism's READY command, and using the same dictionary format.</p>
<h2 id="toc8"><span>The CURVE Mechanism</span></h2>
<p>Roughly, the CURVE mechanism works like PLAIN except that it exchanges encryption keys. CURVE in fact implements CurveZMQ, which is a generic security handshake I'm designing that is taken from CurveCP, a UDP-based security and traffic control protocol designed by cryptographer and mathematician <a href="http://cr.yp.to/djb.html">D. J. Bernstein</a>. CurveCP is based on NaCl, the security library from the same djb.</p>
<p>The security handshake in CurveCP is elegant and relatively simple (compared to other security designs), and comes with a very good pedigree. Whether it really is as robust as djb claims we won't know for a while. However as well as security, CurveCP aims to replace TCP entirely, doing its own traffic control over UDP.</p>
<p>To be honest, I think CurveCP (over UDP) would make a great mechanism in itself for ZMTP but that's a serious challenge. I've tried to keep ZMTP semantically compatible with that idea. In the more pragmatic short term, it turns out that stripping down CurveCP to just the security aspects, assuming TCP is going to be here for some time yet, is feasible.</p>
<p>This is CurveZMQ: the CurveCP handshake taken out and stripped down a little. There's a website, curvezmq.org, but it's still empty. My plan is to take material from curvecp.org, and remix that into a single clean RFC.</p>
<p>It turns out that it's very useful to do end-to-end security on top of 0MQ, as an alternative to doing security in the library. It means you can route over untrusted peers. Imagine I want to make a secure chat application. Two phones, talking to a server in the middle. We don't want the server to ever get clear text data. So the phones do end-to-end security. If we use security in ZMTP, that won't work.</p>
<p>End-to-end security only works with a ROUTER-DEALER combo (or another mix of sockets that can imitate it), since it needs that chatty request-reply handshake. But this is how we build most large-scale services anyhow.</p>
<p>Meaning, at some point I'll write a CurveZMQ mechanism in CZMQ, and show how to use this in a protocol like <a href="http://rfc.zeromq.org/spec:19">http://rfc.zeromq.org/spec:19</a> rfc.zeromq.org/spec:19/FILEMQ or <a href="http://rfc.zeromq.org/spec:20">rfc.zeromq.org/spec:20/ZRE</a>.</p>
<h2 id="toc9"><span>Pluggable Authentication</span></h2>
<p>A protocol shouldn't have an opinion on implementations except when it affects how they work together. But as ZeroMQ users we should be asking, &quot;how does my application plug into this security model?&quot;</p>
<p>The answer is a little subtle. Clearly as peers come and go, we have to invoke code that authenticates them. ZeroMQ can't do this itself in a realistic way. For instance even the PLAIN mechanism could do a remote username / password lookup to some other server.</p>
<p>Our idea is that libzmq provides an inproc socket for authentication and other events. Presumably this would happen on a per-context basis. You then write your authentication logic as a classic ZeroMQ task: connect to a socket, get the events, process them, and send back OK / NOT-OK replies. Meanwhile the &quot;real&quot; application logic continues to run ignorant of the ongoing authentication. It just gets messages and sends messages like today.</p>
<h2 id="toc10"><span>Connection Metadata</span></h2>
<p>Adding a dictionary to the security handshake gives us extensible metadata. Right off, this let me move the socket type and identity out of limbo into a safer home. It also provides a place for more information about the connection.</p>
<p>There's really only one reason to put information upfront in the greeting, and that is when we absolutely need it for security negotiation. You'll see one flag (&quot;as-server&quot;) that tells the mechanism whether the peer is acting as client or server. It means we don't need to rely on the bind/connect order. But all other metadata sits in this dictionary.</p>
<p>As well as socket type and identity, I defined &quot;resource&quot;, which lets us do virtual addressing.</p>
<h2 id="toc11"><span>Virtual Addressing</span></h2>
<p>One of the missing features in ZMTP was <em>virtual addresses</em>. Physical addresses (TCP endpoints) can be costly in some architectures, e.g. when crossing a firewall. If the protocol provides a place for a peer to request a virtual address, during connection negotiation, we can quite easily allow multiple tasks to bind to the same TCP endpoint.</p>
<p>In ZMTP we use the concept of <em>resource</em>, because it fits the schema we already use for zmq_bind and zmq_connect endpoints. Here's how a peer makes a resource available by binding to it:</p>
<div class="code">
<pre>
<code>zmq_bind (publisher, &quot;tcp://*:9001/my/resource/name&quot;);</code>
</pre></div>
<p>Here's how a peer connects to a specific resource on another peer:</p>
<div class="code">
<pre>
<code>zmq_connect (subscriber, &quot;tcp://192.168.55.23:9001/my/resource/name&quot;);</code>
</pre></div>
<p>The implementation will only create one listening TCP socket, but will keep a list of resources available for that listening socket. When a peer connects, the resource it specifies is then used to route messages to the right task.</p>
<p>In ZMTP the resource name comes after the security handshake, so it's encrypted and tamper-proof when we use secure mechanisms (I'll come to mechanisms in a second). Putting the resource name <em>after</em> security does have some implications. It means we cannot use the resource to select credentials. In effect, all connections on a physical endpoint must share the same credentials, e.g. the same server keys.</p>
<p>This isn't really a limitation since TCP in any case does not allow multiple listeners on a port. It's quite plausible to make a mulitiprocess design in which arbitrary processes on a box share a single physical endpoint, by each specifying a different resource. However, there is going to be a single process that does all the zmq_bind commands, acting as proxy for the other processes. And it's sensible that one process has one set of security credentials.</p>
<h2 id="toc12"><span>Security Considerations</span></h2>
<p>I'll collect possible attacks and strategies to defend against them (if you have more suggestions, let's hear them!) Even attacks we can't defend against are worth documenting. So ZMTP makes some recommendations to implementors:</p>
<ul>
<li>Attackers may overwhelm a peer by repeated connection attempts. Thus, a peer MAY log failed accesses, and MAY detect and block repeated failed connections from specific originating IP addresses.</li>
</ul>
<ul>
<li>Attackers may try to cause memory exhaustion in a peer by holding open connections. Thus, a peer MAY allocate memory to a connection only after the security handshake is complete, and MAY limit the number and cost of in-progress handshakes.</li>
</ul>
<ul>
<li>Attackers may try to make small requests that generate large responses back to faked originating addresses (the real target of the attack). This is called an &quot;amplification attack&quot;. Thus, peers MAY limit the number of in-progress handshakes per originating IP address.</li>
</ul>
<ul>
<li>Attackers may try to uncover vulnerable versions of an implementation from its metadata. Thus, ZMTP sends metadata <em>after</em> security handshaking.</li>
</ul>
<ul>
<li>Attackers can use the size of messages (even without breaking encryption) to collect information about the meaning. Thus, on an encrypted connection, message data SHOULD be padded to a randomized minimum size.</li>
</ul>
<ul>
<li>Attackers can use the simple presence or absence of traffic to collect information about the peer (&quot;Person X has come on line&quot;). Thus, on an encrypted connection, the peer SHOULD send random garbage data (&quot;noise&quot;) when there is no other traffic. To fully mask traffic, a peer MAY throttle messages so there is no visible difference between noise and real data.</li>
</ul>
<h2 id="toc13"><span>Conclusions</span></h2>
<p>We're still some way off from a secure ZeroMQ, but we're seeing the mountain clearly now. The next step is to make simple reference implementations of the core protocol and each mechanism. Then, we can implement the new protocol in libzmq, with some minimal authentication hooks. One step at a time&#8230;</p>
<p>So what do you think? Have you tried NaCl or libsodium, and did you like it? Are you more of a DTLS guy, and if so, what do you need to start designing your plugin mechanism for ZMTP/3.0? Are you one of those crazy geniuses who has reimplemented ZMTP/2.0 in Java, C#, Erlang, or Bash? How does this new protocol feel to you? Come and discuss on zeromq-dev.</p>
<div style="float:left;width:33%; margin:-15px 0 0 0">
<p><iframe src="http://hintjens.wdfiles.com/local--html/blog%3A39/6ee948d1838ca3d4501ca3f6f4b7a301ac4fe30a-779106496448022172/hintjens.com/" allowtransparency="true" frameborder="0" class="html-block-iframe"></iframe></p>
</div>
<div style="float:right"><div class="page-rate-widget"><div class="page-rate-widget-start" data-rating="0"></div></div></div>
</div>
<p><a name="comments"></a></p>
<div class="comments-box">
	<h1>Comments</h1>	
	<div class="options" id="comments-options-hidden" style="display: none">
		<a href="javascript:;" onclick="WIKIDOT.modules.ForumCommentsModule.listeners.showComments(event)">Show Comments</a> 
	</div>
		
	<div id="thread-container" class="thread-container reverse" style="margin-top: 1em">
					


<script type="text/javascript">
	WIKIDOT.forumThreadId = 644286;
</script>

        <a href="javascript:;" id="new-post-button" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.newPost(event,null)"
      style="display:  block ; margin-bottom:1em"
    >Add a New Comment</a>

 


<div id="thread-container-posts" style="display: none">
    





</div>


<div style="display:none" id="post-options-template">
	<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.showPermalink(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Permanent Link</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.editPost(event,'%POST_ID%')" class="btn btn-default btn-small btn-sm">Edit</a>
			<a href="javascript:;" onclick="WIKIDOT.modules.ForumViewThreadModule.listeners.deletePost(event,'%POST_ID%')" class="btn btn-danger btn-small btn-sm">Delete</a>
</div>
	
			</div>
	
	
	
</div>
                    </div>

                    



                    
                        <div class="page-tags">
                            <span>
                                <a href="system_page-tags/tag/security.html#pages">security</a><a href="system_page-tags/tag/zeromq.html#pages">zeromq</a>
                            </span>
                        </div>
                    

                    <div id="page-info-break"></div>
                    
                        <div id="page-options-container">
                            
                        </div>
                    
                    <div id="action-area" style="display: none;"></div>
                </div>
            </div>
            
            
            
            <div id="footer" style="display: block; visibility: visible;">
                <div class="options" style="display: block; visibility: visible;">
    <a href="http://www.wikidot.com/doc" id="wikidot-help-button">Help</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:terms-of-service" id="wikidot-tos-button">Terms of Service</a>
    &nbsp;|
    <a href="http://www.wikidot.com/legal:privacy-policy" id="wikidot-privacy-button">Privacy</a>
    &nbsp;|
    <a href="javascript:;" id="bug-report-button" onclick="WIKIDOT.page.listeners.pageBugReport(event)">Report a bug</a>
    &nbsp;|
    <a href="javascript:;" id="abuse-report-button" onclick="WIKIDOT.page.listeners.flagPageObjectionable(event)">Flag as objectionable</a>
</div>
Powered by <a href="http://www.wikidot.com/">Wikidot.com</a> 
            </div>
            
                <div id="license-area" class="license-area">
                    Unless otherwise stated, the content of this page is licensed under <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/">Creative Commons Attribution-ShareAlike 3.0 License</a>
                </div>
            
            
            



            <div id="extrac-div-1"><span></span></div><div id="extrac-div-2"><span></span></div><div id="extrac-div-3"><span></span></div>
            
            
            
            
                
            
        </div>
        
    </div>
<!-- These extra divs/spans may be used as catch-alls to add extra imagery. -->
<div id="extra-div-1"><span></span></div><div id="extra-div-2"><span></span></div><div id="extra-div-3"><span></span></div>
<div id="extra-div-4"><span></span></div><div id="extra-div-5"><span></span></div><div id="extra-div-6"><span></span></div>
</div>



</div>
<div id="dummy-ondomready-block" style="display: none;" ></div>
    <!-- Google Analytics load -->
    <script type="text/javascript">
        (function() {
            var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
            ga.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + 'stats.g.doubleclick.net/dc.js';
            var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
        })();
    </script>

    <!-- Quantcast -->
    <script type="text/javascript">
    _qoptions={
        qacct:"p-edL3gsnUjJzw-"
    };
    (function() {
        var qc = document.createElement('script'); qc.type = 'text/javascript'; qc.async = true;
        qc.src = ('https:' == document.location.protocol ? 'https://secure' : 'http://edge') + '.quantserve.com/quant.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(qc, s);
    })();
    </script>
    <noscript>
        <img src="http://pixel.quantserve.com/pixel/p-edL3gsnUjJzw-.gif" style="display: none;" border="0" height="1" width="1" alt="Quantcast"/>
    </noscript>




<div id="page-options-bottom-tips" style="display: none;">
    <div id="edit-button-hovertip">
        Click here to edit contents of this page.    </div>
</div>
<div id="page-options-bottom-2-tips"  style="display: none;">
    <div id="edit-sections-button-hovertip">
        Click here to toggle editing of individual sections of the page (if possible).         Watch headings for an &quot;edit&quot; link when available.    </div>
    <div id="edit-append-button-hovertip">
        Append content without editing the whole page source.    </div>
    <div id="history-button-hovertip">
        Check out how this page has evolved in the past.    </div>
    <div id="discuss-button-hovertip">
        If you want to discuss contents of this page - this is the easiest way to do it.    </div>
    <div id="files-button-hovertip">
        View and manage file attachments for this page.    </div>
    <div id="site-tools-button-hovertip">
        A few useful tools to manage this Site.    </div>
    <div id="backlinks-button-hovertip">
        See pages that link to and include this page.    </div>
    <div id="rename-move-button-hovertip">
        Change the name (also URL address, possibly the category) of the page.    </div>
    <div id="view-source-button-hovertip">
        View wiki source for this page without editing.    </div>
    <div id="parent-page-button-hovertip">  
        View/set parent page (used for creating breadcrumbs and structured layout).    </div>
            <div id="abuse-report-button-hovertip">
            Notify administrators if there is objectionable content in this page.        </div>
        <div id="bug-report-button-hovertip">
            Something does not work as expected? Find out what you can do.        </div>
        <div id="wikidot-help-button-hovertip">
            General Wikidot.com documentation and help section.        </div>
        <div id="wikidot-tos-button-hovertip">
            Wikidot.com Terms of Service - what you can, what you should not etc.        </div>
        <div id="wikidot-privacy-button-hovertip">
            Wikidot.com Privacy Policy.          
        </div>
    </div>
</body>

<!-- Mirrored from hintjens.com/blog:39 by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 09 Oct 2019 09:31:04 GMT -->
</html>